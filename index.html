<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Dinger Tracker</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    .stat-box {
      @apply bg-slate-800 rounded-lg p-2 flex flex-col items-center justify-center text-center;
    }
    .stat-label {
      @apply text-xs text-gray-400;
    }
    .stat-value {
      @apply text-base font-semibold;
    }
    
    /* Force consistent date input sizing on all browsers, especially iOS Safari */
    input[type="date"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 100% !important;
      height: 2.5rem !important;
      padding: 0.625rem 0.75rem !important;
      font-size: 1rem !important;
      line-height: 1.5 !important;
      box-sizing: border-box !important;
      border-radius: 0.375rem !important;
    }
    
    /* Ensure date input doesn't expand beyond container */
    input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 1;
      cursor: pointer;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="bg-slate-900 py-4 shadow-lg">
    <h1 class="text-center text-4xl font-bold text-yellow-400">Dinger Tracker</h1>
  </header>

  <main class="container mx-auto px-4 py-6 flex-1">
    <!-- Navigation Tabs -->
    <div class="flex justify-center mb-6">
      <div class="bg-slate-800 rounded-lg p-1 flex">
        <button id="dingers-tab" class="px-4 py-2 rounded-md bg-yellow-500 text-black font-semibold transition">Dingers</button>
        <button id="bets-tab" class="px-4 py-2 rounded-md text-gray-400 hover:text-white transition">Bets</button>
      </div>
    </div>

    <!-- Dingers Section -->
    <div id="dingers-section">
      <!-- Date Selector -->
      <div class="flex flex-col sm:flex-row sm:justify-center gap-3 mb-6">
        <input type="date" id="date-selector" class="bg-slate-800 text-white px-3 py-2 rounded-md border border-slate-700">
        <button id="fetch-button" class="bg-yellow-500 text-black font-semibold px-4 py-2 rounded-md hover:bg-yellow-400">Get Dingers</button>
      </div>
    </div>

    <!-- Bets Section -->
    <div id="bets-section" class="hidden">
      <!-- Bet Entry Form -->
      <div class="bg-slate-800 rounded-lg p-6 mb-6 max-w-md mx-auto">
        <h2 class="text-xl font-bold text-yellow-400 mb-4 text-center">Add Home Run Bet</h2>
        <form id="bet-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Bet Date</label>
            <input type="date" id="bet-date" required class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Bettor Name</label>
            <div class="relative">
              <input type="text" id="bettor-name" required autocomplete="off" class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10" placeholder="Enter bettor name...">
              <div id="bettor-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-md max-h-40 overflow-y-auto">
                <div id="bettor-list"></div>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Batter Name</label>
            <div class="relative">
              <input type="text" id="batter-name" required autocomplete="off" class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10" placeholder="Search for player...">
              <div id="player-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-md max-h-60 overflow-y-auto">
                <div id="player-loading" class="hidden p-3 text-center text-gray-400">Loading players...</div>
                <div id="player-list"></div>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Bet Amount ($)</label>
            <input type="number" id="bet-amount" required min="0" step="0.01" class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Odds</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">+</span>
              <input type="number" id="bet-odds" required min="100" step="1" class="w-full bg-slate-700 text-white pl-8 pr-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10" placeholder="150">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Sportsbook</label>
            <select id="sportsbook" required class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
              <option value="">Select sportsbook...</option>
              <option value="DraftKings">DraftKings</option>
              <option value="FanDuel">FanDuel</option>
              <option value="BetMGM">BetMGM</option>
              <option value="Caesars">Caesars</option>
              <option value="BetRivers">BetRivers</option>
              <option value="Fanatics">Fanatics</option>
              <option value="ESPN BET">ESPN BET</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-yellow-500 text-black font-semibold py-2 rounded-md hover:bg-yellow-400 transition">Add Bet</button>
        </form>
      </div>

      <!-- Payout Calculator -->
      <div class="bg-slate-800 rounded-lg p-6 mb-6 max-w-md mx-auto">
        <h2 class="text-xl font-bold text-yellow-400 mb-4 text-center">Payout Calculator</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Calculate Date</label>
            <input type="date" id="payout-date" required class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
          </div>
          <button id="calculate-payouts" class="w-full bg-green-500 text-white font-semibold py-2 rounded-md hover:bg-green-400 transition">Calculate Payouts</button>
        </div>
        
        <!-- Payout Results -->
        <div id="payout-results" class="hidden mt-6">
          <h3 class="text-lg font-bold text-yellow-400 mb-3">Payout Results</h3>
          <div id="payout-summary" class="mb-4 p-3 bg-slate-700 rounded-lg">
            <div class="text-sm text-gray-300">
              <div>Total Bets: <span id="total-bets-count" class="text-white font-semibold">0</span></div>
              <div>Total Wagered: <span id="total-wagered-amount" class="text-white font-semibold">$0</span></div>
              <div>Total Won: <span id="total-won-amount" class="text-green-400 font-semibold">$0</span></div>
              <div>Total Profit: <span id="total-profit-amount" class="text-green-400 font-semibold">$0</span></div>
              <div>Unique Bettors: <span id="unique-bettors-count" class="text-white font-semibold">0</span></div>
              <div>Pool Payout Per Person: <span id="pool-payout-per-person" class="text-yellow-400 font-semibold">$0</span></div>
            </div>
          </div>
          <div id="payout-breakdown" class="space-y-2"></div>
        </div>
      </div>

      <!-- Open Bets -->
      <div id="open-bets-section">
        <h2 class="text-2xl font-bold text-center mb-6 text-yellow-400">Open Bets</h2>
        <div id="open-bets-list" class="space-y-3"></div>
      </div>

      <!-- Settled Bets -->
      <div id="settled-bets-section" class="hidden mt-8">
        <div class="flex justify-center items-center gap-4 mb-6">
          <h2 class="text-2xl font-bold text-yellow-400">Settled Bets</h2>
        </div>
        <div id="settled-bets-list" class="space-y-3"></div>
      </div>

      <!-- Show Hidden Button (always visible when there are hidden bets) -->
      <div id="show-hidden-section" class="hidden mt-6 text-center">
        <button id="toggle-hidden-bets" class="bg-slate-700 text-white px-4 py-2 rounded hover:bg-slate-600 transition">
          Show Hidden (<span id="hidden-count">0</span>)
        </button>
      </div>

      <!-- Hidden Bets -->
      <div id="hidden-bets-section" class="hidden mt-8">
        <div class="flex justify-center items-center gap-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-400">Hidden Bets</h2>
          <button id="hide-hidden-bets" class="bg-slate-700 text-white px-3 py-1 rounded text-sm hover:bg-slate-600 transition">
            Hide This Section
          </button>
        </div>
        <div id="hidden-bets-list" class="space-y-3"></div>
      </div>

      <!-- Confirmation Modal -->
      <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-sm mx-4">
          <h3 class="text-lg font-bold text-yellow-400 mb-4">Confirm Deletion</h3>
          <p class="text-gray-300 mb-6">Are you sure you want to delete this bet? This action cannot be undone.</p>
          <div class="flex gap-3 justify-end">
            <button id="cancel-delete" class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-500 transition">Cancel</button>
            <button id="confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500 transition">Delete</button>
          </div>
        </div>
      </div>

      <!-- Edit Bet Modal -->
      <div id="edit-bet-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-lg max-w-md mx-4 w-full">
          <h3 class="text-lg font-bold text-yellow-400 mb-4">Edit Bet</h3>
          <form id="edit-bet-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Bettor Name</label>
              <div class="relative">
                <input type="text" id="edit-bettor-name" required autocomplete="off" class="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none" placeholder="Enter bettor name...">
                <div id="edit-bettor-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-md max-h-40 overflow-y-auto">
                  <div id="edit-bettor-list"></div>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Batter Name</label>
              <div class="relative">
                <input type="text" id="edit-batter-name" required autocomplete="off" class="w-full bg-slate-700 text-white px-3 py-2 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none" placeholder="Search for player...">
                <div id="edit-player-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-md max-h-60 overflow-y-auto">
                  <div id="edit-player-loading" class="hidden p-3 text-center text-gray-400">Loading players...</div>
                  <div id="edit-player-list"></div>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Bet Date</label>
              <input type="date" id="edit-bet-date" required class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Bet Amount ($)</label>
              <input type="number" id="edit-bet-amount" required min="0" step="0.01" class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Odds</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">+</span>
                <input type="number" id="edit-bet-odds" required min="100" step="1" class="w-full bg-slate-700 text-white pl-8 pr-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10" placeholder="150">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Sportsbook</label>
              <select id="edit-sportsbook" required class="w-full bg-slate-700 text-white px-3 py-2.5 rounded-md border border-slate-600 focus:border-yellow-400 focus:outline-none h-10">
                <option value="">Select sportsbook...</option>
                <option value="DraftKings">DraftKings</option>
                <option value="FanDuel">FanDuel</option>
                <option value="BetMGM">BetMGM</option>
                <option value="Caesars">Caesars</option>
                <option value="BetRivers">BetRivers</option>
                <option value="Fanatics">Fanatics</option>
                <option value="ESPN BET">ESPN BET</option>
              </select>
            </div>
            <div class="flex gap-3 justify-end">
              <button type="button" id="cancel-edit" class="bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-500 transition">Cancel</button>
              <button type="submit" class="bg-yellow-500 text-black font-semibold px-4 py-2 rounded hover:bg-yellow-400 transition">Save Changes</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bet Summary -->
      <div id="bet-summary-section" class="hidden mt-6">
        <div class="flex flex-wrap justify-center gap-4">
          <div class="bg-slate-800 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-400">Total Wagered</div>
            <div id="total-wagered" class="text-xl font-bold text-red-400">$0</div>
          </div>
          <div class="bg-slate-800 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-400">Total Winnings</div>
            <div id="total-winnings" class="text-xl font-bold text-green-400">$0</div>
          </div>
          <div class="bg-slate-800 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-400">Net P&L</div>
            <div id="net-pl" class="text-xl font-bold">$0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Last Updated -->
    <div id="last-updated" class="hidden text-center text-xs text-gray-500 mb-6"></div>

    <!-- Loading -->
    <div id="loading-state" class="hidden text-center text-gray-400 mb-6">Loading dingers...</div>
    <div id="error-message" class="hidden text-center text-red-500 font-semibold mb-6">Failed to load data. Please try again.</div>

    <!-- Summary -->
    <div id="summary-section" class="hidden flex flex-wrap justify-center gap-4 mb-6">
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-xs text-gray-400">Total HRs</div>
        <div id="hr-count" class="text-xl font-bold">0</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-xs text-gray-400">Avg Exit Velo</div>
        <div id="avg-exit-velocity" class="text-xl font-bold">0</div>
      </div>
      <div class="bg-slate-800 rounded-lg p-4 text-center">
        <div class="text-xs text-gray-400">Time Since Last</div>
        <div id="time-since-last" class="text-xl font-bold">N/A</div>
      </div>
    </div>

    <!-- Home Runs -->
    <div id="hr-list" class="hidden space-y-4"></div>
  </main>

  <script>
    const dateSelector = document.getElementById('date-selector');
    const fetchButton = document.getElementById('fetch-button');
    const hrList = document.getElementById('hr-list');
    const hrCountEl = document.getElementById('hr-count');
    const avgExitVelocityEl = document.getElementById('avg-exit-velocity');
    const summarySection = document.getElementById('summary-section');
    const loadingState = document.getElementById('loading-state');
    const errorMessage = document.getElementById('error-message');

    // Tab elements
    const dingersTab = document.getElementById('dingers-tab');
    const betsTab = document.getElementById('bets-tab');
    const dingersSection = document.getElementById('dingers-section');
    const betsSection = document.getElementById('bets-section');

    // Bet elements
    const betForm = document.getElementById('bet-form');
    const openBetsList = document.getElementById('open-bets-list');
    const settledBetsList = document.getElementById('settled-bets-list');
    const settledBetsSection = document.getElementById('settled-bets-section');
    const hiddenBetsList = document.getElementById('hidden-bets-list');
    const hiddenBetsSection = document.getElementById('hidden-bets-section');
    const betSummarySection = document.getElementById('bet-summary-section');
    const totalWageredEl = document.getElementById('total-wagered');
    const totalWinningsEl = document.getElementById('total-winnings');
    const netPlEl = document.getElementById('net-pl');

    // Modal elements
    const confirmationModal = document.getElementById('confirmation-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    const toggleHiddenBtn = document.getElementById('toggle-hidden-bets');
    const hideHiddenBtn = document.getElementById('hide-hidden-bets');
    const hiddenCountEl = document.getElementById('hidden-count');

    // Player dropdown elements
    const batterNameInput = document.getElementById('batter-name');
    const playerDropdown = document.getElementById('player-dropdown');
    const playerLoading = document.getElementById('player-loading');
    const playerList = document.getElementById('player-list');
    const betDateInput = document.getElementById('bet-date');

    // Bettor dropdown elements
    const bettorNameInput = document.getElementById('bettor-name');
    const bettorDropdown = document.getElementById('bettor-dropdown');
    const bettorList = document.getElementById('bettor-list');

    const today = new Date();
    const localISODate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const todayStr = localISODate.toISOString().split('T')[0];
    dateSelector.value = todayStr;

    // Event listeners
    fetchButton.addEventListener('click', getDingerData);
    dingersTab.addEventListener('click', () => switchTab('dingers'));
    betsTab.addEventListener('click', () => switchTab('bets'));
    betForm.addEventListener('submit', addBet);

    // Bet management
    let activeBets = JSON.parse(localStorage.getItem('hrBets') || '[]');
    let currentHomeRuns = [];
    let allPlayers = [];
    let filteredPlayers = [];
    let savedBettors = JSON.parse(localStorage.getItem('hrBettors') || '[]');
    let filteredBettors = [];
    let pendingDeleteId = null;
    let showingHiddenBets = false;
    let editingBetId = null;

    // Initialize
    renderActiveBets();
    updateBetSummary();
    setupPlayerDropdown();
    setupBettorDropdown();
    setupEditDropdowns();
    loadSavedBettors(); // Load all bettor names from existing bets
    setupBetManagement();
    
    // Set default bet date to today
    betDateInput.value = todayStr;
    
    // Set default payout calculation date to today
    document.getElementById('payout-date').value = todayStr;
    
    // Setup payout calculator
    document.getElementById('calculate-payouts').addEventListener('click', calculatePayouts);
    document.getElementById('payout-date').addEventListener('change', () => {
      // Auto-recalculate when date changes if results are currently showing
      if (!document.getElementById('payout-results').classList.contains('hidden')) {
        calculatePayouts();
      }
    });

    function setupBetManagement() {
      // Modal event listeners
      cancelDeleteBtn.addEventListener('click', hideConfirmationModal);
      confirmDeleteBtn.addEventListener('click', confirmDelete);
      
      // Edit modal event listeners
      const editBetModal = document.getElementById('edit-bet-modal');
      const editBetForm = document.getElementById('edit-bet-form');
      const cancelEditBtn = document.getElementById('cancel-edit');
      
      editBetForm.addEventListener('submit', saveEditedBet);
      cancelEditBtn.addEventListener('click', hideEditModal);
      
      // Hidden bets toggle
      toggleHiddenBtn.addEventListener('click', toggleHiddenBets);
      hideHiddenBtn.addEventListener('click', hideHiddenBets);
      
      // Close modals on background click
      confirmationModal.addEventListener('click', (e) => {
        if (e.target === confirmationModal) {
          hideConfirmationModal();
        }
      });
      
      editBetModal.addEventListener('click', (e) => {
        if (e.target === editBetModal) {
          hideEditModal();
        }
      });
    }

    function showConfirmationModal(betId) {
      pendingDeleteId = betId;
      confirmationModal.classList.remove('hidden');
    }

    function hideConfirmationModal() {
      pendingDeleteId = null;
      confirmationModal.classList.add('hidden');
    }

    function confirmDelete() {
      if (pendingDeleteId) {
        removeBet(pendingDeleteId);
        hideConfirmationModal();
      }
    }

    function toggleHiddenBets() {
      showingHiddenBets = !showingHiddenBets;
      if (showingHiddenBets) {
        hiddenBetsSection.classList.remove('hidden');
        toggleHiddenBtn.textContent = `Hide Hidden (${getHiddenBets().length})`;
      } else {
        hiddenBetsSection.classList.add('hidden');
        toggleHiddenBtn.innerHTML = `Show Hidden (<span id="hidden-count">${getHiddenBets().length}</span>)`;
      }
    }

    function hideHiddenBets() {
      showingHiddenBets = false;
      hiddenBetsSection.classList.add('hidden');
      toggleHiddenBtn.innerHTML = `Show Hidden (<span id="hidden-count">${getHiddenBets().length}</span>)`;
    }

    function getHiddenBets() {
      return activeBets.filter(bet => bet.hidden === true);
    }

    function hideBet(betId) {
      const bet = activeBets.find(b => b.id === betId);
      if (bet) {
        bet.hidden = true;
        localStorage.setItem('hrBets', JSON.stringify(activeBets));
        renderActiveBets();
        updateBetSummary();
      }
    }

    function unhideBet(betId) {
      const bet = activeBets.find(b => b.id === betId);
      if (bet) {
        bet.hidden = false;
        localStorage.setItem('hrBets', JSON.stringify(activeBets));
        renderActiveBets();
        updateBetSummary();
      }
    }

    function loadSavedBettors() {
      // Extract all unique bettor names from existing bets
      const allBettorNames = [...new Set(activeBets.map(bet => bet.bettor))];
      
      // Merge with any previously saved bettors and remove duplicates
      const combinedBettors = [...new Set([...savedBettors, ...allBettorNames])];
      
      // Update the saved bettors list
      savedBettors = combinedBettors.sort();
      filteredBettors = [...savedBettors];
      
      // Save to localStorage
      localStorage.setItem('hrBettors', JSON.stringify(savedBettors));
    }

    async function fetchAllMLBPlayers() {
      try {
        playerLoading.classList.remove('hidden');
        
        // Get all MLB teams first
        const teamsResp = await fetch('https://statsapi.mlb.com/api/v1/teams?sportId=1');
        const teamsData = await teamsResp.json();
        const activeTeams = teamsData.teams.filter(team => team.active);

        const playerSet = new Set();
        const teamPromises = [];

        // Fetch roster for each team
        for (const team of activeTeams) {
          teamPromises.push(
            fetch(`https://statsapi.mlb.com/api/v1/teams/${team.id}/roster`)
              .then(r => r.json())
              .then(rosterData => {
                if (rosterData.roster) {
                  rosterData.roster.forEach(player => {
                    if (player.person && player.position &&
                        player.position.type !== 'Pitcher' &&
                        player.position.abbreviation !== 'P') {
                      
                      const playerData = {
                        id: player.person.id,
                        name: player.person.fullName,
                        team: team.abbreviation
                      };
                      
                      playerSet.add(JSON.stringify(playerData));
                    }
                  });
                }
              })
              .catch(e => console.warn(`Error fetching roster for ${team.name}:`, e))
          );
        }

        await Promise.all(teamPromises);
        
        // Convert set back to array and sort
        allPlayers = Array.from(playerSet)
          .map(p => JSON.parse(p))
          .sort((a, b) => a.name.localeCompare(b.name));
        
        filteredPlayers = [...allPlayers];
        
        playerLoading.classList.add('hidden');
        console.log(`Loaded ${allPlayers.length} position players from all MLB teams`);
        
      } catch (error) {
        console.error('Error fetching players:', error);
        playerLoading.classList.add('hidden');
      }
    }

    function setupPlayerDropdown() {
      batterNameInput.addEventListener('input', handlePlayerSearch);
      batterNameInput.addEventListener('focus', showPlayerDropdown);
      batterNameInput.addEventListener('blur', hidePlayerDropdownDelayed);
      
      // Load players when bets tab is first opened
      betsTab.addEventListener('click', () => {
        if (allPlayers.length === 0) {
          fetchAllMLBPlayers();
        }
      });
    }

    function handlePlayerSearch(e) {
      const query = e.target.value.toLowerCase().trim();
      
      if (query.length === 0) {
        filteredPlayers = [...allPlayers];
      } else {
        filteredPlayers = allPlayers.filter(player =>
          player.name.toLowerCase().includes(query) ||
          player.team.toLowerCase().includes(query)
        );
      }
      
      renderPlayerDropdown();
      showPlayerDropdown();
    }

    function renderPlayerDropdown() {
      playerList.innerHTML = '';
      
      if (filteredPlayers.length === 0) {
        playerList.innerHTML = '<div class="p-3 text-gray-400 text-center">No players found</div>';
        return;
      }
      
      filteredPlayers.slice(0, 50).forEach(player => { // Limit to 50 results
        const item = document.createElement('div');
        item.className = 'p-2 hover:bg-slate-600 cursor-pointer flex justify-between items-center';
        item.innerHTML = `
          <span class="text-white">${player.name}</span>
          <span class="text-gray-400 text-sm">${player.team}</span>
        `;
        
        item.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent blur event
          selectPlayer(player);
        });
        
        playerList.appendChild(item);
      });
    }

    function selectPlayer(player) {
      batterNameInput.value = player.name;
      hidePlayerDropdown();
    }

    function showPlayerDropdown() {
      if (allPlayers.length > 0) {
        renderPlayerDropdown();
        playerDropdown.classList.remove('hidden');
      }
    }

    function hidePlayerDropdown() {
      playerDropdown.classList.add('hidden');
    }

    function hidePlayerDropdownDelayed() {
      setTimeout(hidePlayerDropdown, 150); // Small delay to allow click events
    }

    function setupBettorDropdown() {
      bettorNameInput.addEventListener('input', handleBettorSearch);
      bettorNameInput.addEventListener('focus', showBettorDropdown);
      bettorNameInput.addEventListener('blur', hideBettorDropdownDelayed);
    }

    function handleBettorSearch(e) {
      const query = e.target.value.toLowerCase().trim();
      
      if (query.length === 0) {
        filteredBettors = [...savedBettors];
      } else {
        filteredBettors = savedBettors.filter(bettor =>
          bettor.toLowerCase().includes(query)
        );
      }
      
      renderBettorDropdown();
      showBettorDropdown();
    }

    function renderBettorDropdown() {
      bettorList.innerHTML = '';
      
      if (filteredBettors.length === 0) {
        bettorDropdown.classList.add('hidden');
        return;
      }
      
      filteredBettors.forEach(bettor => {
        const item = document.createElement('div');
        item.className = 'p-2 hover:bg-slate-600 cursor-pointer';
        item.innerHTML = `<span class="text-white">${bettor}</span>`;
        
        item.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent blur event
          selectBettor(bettor);
        });
        
        bettorList.appendChild(item);
      });
    }

    function selectBettor(bettor) {
      bettorNameInput.value = bettor;
      hideBettorDropdown();
    }

    function showBettorDropdown() {
      if (savedBettors.length > 0) {
        renderBettorDropdown();
        if (filteredBettors.length > 0) {
          bettorDropdown.classList.remove('hidden');
        }
      }
    }

    function hideBettorDropdown() {
      bettorDropdown.classList.add('hidden');
    }

    function hideBettorDropdownDelayed() {
      setTimeout(hideBettorDropdown, 150); // Small delay to allow click events
    }

    function saveBettor(bettorName) {
      if (!savedBettors.includes(bettorName)) {
        savedBettors.push(bettorName);
        savedBettors.sort(); // Keep alphabetical order
        localStorage.setItem('hrBettors', JSON.stringify(savedBettors));
        filteredBettors = [...savedBettors];
      }
    }

    // Edit bet functionality
    function showEditModal(betId) {
      const bet = activeBets.find(b => b.id === betId);
      if (!bet) return;
      
      editingBetId = betId;
      
      // Populate form with current bet data
      document.getElementById('edit-bettor-name').value = bet.bettor;
      document.getElementById('edit-batter-name').value = bet.batter;
      document.getElementById('edit-bet-date').value = bet.betDate;
      document.getElementById('edit-bet-amount').value = bet.amount;
      document.getElementById('edit-bet-odds').value = bet.odds.replace('+', '');
      document.getElementById('edit-sportsbook').value = bet.sportsbook;
      
      document.getElementById('edit-bet-modal').classList.remove('hidden');
    }

    function hideEditModal() {
      editingBetId = null;
      document.getElementById('edit-bet-form').reset();
      document.getElementById('edit-bet-modal').classList.add('hidden');
    }

    function saveEditedBet(e) {
      e.preventDefault();
      
      if (!editingBetId) return;
      
      const bettor = document.getElementById('edit-bettor-name').value.trim();
      const batter = document.getElementById('edit-batter-name').value.trim();
      const betDate = document.getElementById('edit-bet-date').value;
      const amount = parseFloat(document.getElementById('edit-bet-amount').value);
      const oddsValue = parseInt(document.getElementById('edit-bet-odds').value);
      const sportsbook = document.getElementById('edit-sportsbook').value;

      if (!bettor || !batter || !betDate || !amount || !oddsValue || !sportsbook) return;

      // Find the selected player's team from the dropdown
      let batterTeam = '';
      const selectedPlayer = allPlayers.find(player =>
        player.name.toLowerCase() === batter.toLowerCase()
      );
      if (selectedPlayer) {
        batterTeam = selectedPlayer.team;
      }

      const betIndex = activeBets.findIndex(bet => bet.id === editingBetId);
      if (betIndex !== -1) {
        // Preserve original bet properties but update editable fields
        activeBets[betIndex] = {
          ...activeBets[betIndex],
          bettor,
          batter,
          batterTeam,
          betDate,
          amount,
          odds: `+${oddsValue}`,
          sportsbook
        };
        
        localStorage.setItem('hrBets', JSON.stringify(activeBets));
        saveBettor(bettor);
        renderActiveBets();
        updateBetSummary();
        hideEditModal();
      }
    }

    function setupEditDropdowns() {
      const editBettorInput = document.getElementById('edit-bettor-name');
      const editBettorDropdown = document.getElementById('edit-bettor-dropdown');
      const editBettorList = document.getElementById('edit-bettor-list');
      
      const editBatterInput = document.getElementById('edit-batter-name');
      const editPlayerDropdown = document.getElementById('edit-player-dropdown');
      const editPlayerList = document.getElementById('edit-player-list');
      
      // Bettor dropdown for edit modal
      editBettorInput.addEventListener('input', (e) => handleEditBettorSearch(e, editBettorList));
      editBettorInput.addEventListener('focus', () => showEditBettorDropdown(editBettorDropdown, editBettorList));
      editBettorInput.addEventListener('blur', () => setTimeout(() => editBettorDropdown.classList.add('hidden'), 150));
      
      // Player dropdown for edit modal
      editBatterInput.addEventListener('input', (e) => handleEditPlayerSearch(e, editPlayerList));
      editBatterInput.addEventListener('focus', () => showEditPlayerDropdown(editPlayerDropdown, editPlayerList));
      editBatterInput.addEventListener('blur', () => setTimeout(() => editPlayerDropdown.classList.add('hidden'), 150));
    }

    function handleEditBettorSearch(e, listElement) {
      const query = e.target.value.toLowerCase().trim();
      let filtered = query.length === 0 ? [...savedBettors] :
                    savedBettors.filter(bettor => bettor.toLowerCase().includes(query));
      
      renderEditBettorDropdown(listElement, filtered);
      showEditBettorDropdown(document.getElementById('edit-bettor-dropdown'), listElement);
    }

    function renderEditBettorDropdown(listElement, bettors) {
      listElement.innerHTML = '';
      
      if (bettors.length === 0) {
        document.getElementById('edit-bettor-dropdown').classList.add('hidden');
        return;
      }
      
      bettors.forEach(bettor => {
        const item = document.createElement('div');
        item.className = 'p-2 hover:bg-slate-600 cursor-pointer';
        item.innerHTML = `<span class="text-white">${bettor}</span>`;
        
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
          document.getElementById('edit-bettor-name').value = bettor;
          document.getElementById('edit-bettor-dropdown').classList.add('hidden');
        });
        
        listElement.appendChild(item);
      });
    }

    function showEditBettorDropdown(dropdownElement, listElement) {
      if (savedBettors.length > 0) {
        renderEditBettorDropdown(listElement, savedBettors);
        if (listElement.children.length > 0) {
          dropdownElement.classList.remove('hidden');
        }
      }
    }

    function handleEditPlayerSearch(e, listElement) {
      const query = e.target.value.toLowerCase().trim();
      let filtered = query.length === 0 ? [...allPlayers] :
                    allPlayers.filter(player =>
                      player.name.toLowerCase().includes(query) ||
                      player.team.toLowerCase().includes(query)
                    );
      
      renderEditPlayerDropdown(listElement, filtered);
      showEditPlayerDropdown(document.getElementById('edit-player-dropdown'), listElement);
    }

    function renderEditPlayerDropdown(listElement, players) {
      listElement.innerHTML = '';
      
      if (players.length === 0) {
        listElement.innerHTML = '<div class="p-3 text-gray-400 text-center">No players found</div>';
        return;
      }
      
      players.slice(0, 50).forEach(player => {
        const item = document.createElement('div');
        item.className = 'p-2 hover:bg-slate-600 cursor-pointer flex justify-between items-center';
        item.innerHTML = `
          <span class="text-white">${player.name}</span>
          <span class="text-gray-400 text-sm">${player.team}</span>
        `;
        
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
          document.getElementById('edit-batter-name').value = player.name;
          document.getElementById('edit-player-dropdown').classList.add('hidden');
        });
        
        listElement.appendChild(item);
      });
    }

    function showEditPlayerDropdown(dropdownElement, listElement) {
      if (allPlayers.length > 0) {
        renderEditPlayerDropdown(listElement, allPlayers);
        dropdownElement.classList.remove('hidden');
      }
    }

    function switchTab(tab) {
      if (tab === 'dingers') {
        dingersTab.className = 'px-4 py-2 rounded-md bg-yellow-500 text-black font-semibold transition';
        betsTab.className = 'px-4 py-2 rounded-md text-gray-400 hover:text-white transition';
        dingersSection.classList.remove('hidden');
        betsSection.classList.add('hidden');
      } else {
        betsTab.className = 'px-4 py-2 rounded-md bg-yellow-500 text-black font-semibold transition';
        dingersTab.className = 'px-4 py-2 rounded-md text-gray-400 hover:text-white transition';
        betsSection.classList.remove('hidden');
        dingersSection.classList.add('hidden');
      }
    }

    function addBet(e) {
      e.preventDefault();
      
      const bettor = document.getElementById('bettor-name').value.trim();
      const batter = document.getElementById('batter-name').value.trim();
      const betDate = document.getElementById('bet-date').value;
      const amount = parseFloat(document.getElementById('bet-amount').value);
      const oddsValue = parseInt(document.getElementById('bet-odds').value);
      const sportsbook = document.getElementById('sportsbook').value;

      if (!bettor || !batter || !betDate || !amount || !oddsValue || !sportsbook) return;

      // Find the selected player's team from the dropdown
      let batterTeam = '';
      const selectedPlayer = allPlayers.find(player =>
        player.name.toLowerCase() === batter.toLowerCase()
      );
      if (selectedPlayer) {
        batterTeam = selectedPlayer.team;
      }

      const bet = {
        id: Date.now(),
        bettor,
        batter,
        batterTeam,
        betDate,
        amount,
        odds: `+${oddsValue}`, // Always format as positive
        sportsbook,
        dateCreated: new Date().toISOString(),
        status: 'active', // active, won, lost
        winnings: 0
      };

      activeBets.push(bet);
      localStorage.setItem('hrBets', JSON.stringify(activeBets));
      
      // Save bettor name for future use
      saveBettor(bettor);
      
      betForm.reset();
      betDateInput.value = todayStr; // Reset to today's date
      renderActiveBets();
      updateBetSummary();
    }

    function removeBet(betId) {
      activeBets = activeBets.filter(bet => bet.id !== betId);
      localStorage.setItem('hrBets', JSON.stringify(activeBets));
      renderActiveBets();
      updateBetSummary();
    }

    function calculateWinnings(amount, odds) {
      const oddsNum = parseInt(odds.replace(/[+\-]/g, ''));
      // Since all odds are positive now, always use positive calculation
      return amount * (oddsNum / 100);
    }

    function renderActiveBets() {
      const openBets = activeBets.filter(bet => bet.status === 'active' && !bet.hidden);
      const settledBets = activeBets.filter(bet => bet.status !== 'active' && !bet.hidden);
      const hiddenBets = getHiddenBets();
      
      // Render open bets
      openBetsList.innerHTML = '';
      if (openBets.length === 0) {
        openBetsList.innerHTML = '<div class="text-center text-gray-400 py-8">No open bets</div>';
      } else {
        openBets.forEach(bet => {
          const card = createBetCard(bet);
          openBetsList.appendChild(card);
        });
      }

      // Render settled bets
      settledBetsList.innerHTML = '';
      if (settledBets.length === 0) {
        settledBetsSection.classList.add('hidden');
      } else {
        settledBetsSection.classList.remove('hidden');
        settledBets.forEach(bet => {
          const card = createBetCard(bet);
          settledBetsList.appendChild(card);
        });
      }

      // Render hidden bets
      hiddenBetsList.innerHTML = '';
      if (hiddenBets.length === 0) {
        if (showingHiddenBets) {
          hiddenBetsList.innerHTML = '<div class="text-center text-gray-400 py-8">No hidden bets</div>';
        }
      } else {
        hiddenBets.forEach(bet => {
          const card = createBetCard(bet, true);
          hiddenBetsList.appendChild(card);
        });
      }

      // Update hidden count
      const hiddenCount = hiddenBets.length;
      if (document.getElementById('hidden-count')) {
        document.getElementById('hidden-count').textContent = hiddenCount;
      }
      
      // Show/hide hidden bets button section
      const showHiddenSection = document.getElementById('show-hidden-section');
      if (hiddenCount > 0) {
        showHiddenSection.classList.remove('hidden');
      } else {
        showHiddenSection.classList.add('hidden');
        hideHiddenBets();
      }

      // Show/hide summary
      const visibleBets = activeBets.filter(bet => !bet.hidden);
      if (visibleBets.length === 0) {
        betSummarySection.classList.add('hidden');
      } else {
        betSummarySection.classList.remove('hidden');
      }
    }

    function createBetCard(bet, isHidden = false) {
      const card = document.createElement('div');
      const cardClass = isHidden ? 'bg-slate-700 opacity-75' : 'bg-slate-800';
      card.className = `${cardClass} p-4 rounded-lg ${bet.status === 'won' ? 'border-l-4 border-green-400' : bet.status === 'lost' ? 'border-l-4 border-red-400' : ''}`;
      
      const potentialWin = calculateWinnings(bet.amount, bet.odds);
      const statusBadge = bet.status === 'won' ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">WON</span>' :
                         bet.status === 'lost' ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">LOST</span>' :
                         '<span class="bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold">OPEN</span>';

      const actionButtons = isHidden ?
        `<button onclick="unhideBet(${bet.id})" class="text-blue-400 hover:text-blue-300 text-sm mr-2">Show</button>
         <button onclick="showConfirmationModal(${bet.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>` :
        bet.status === 'active' ?
        `<button onclick="showEditModal(${bet.id})" class="text-blue-400 hover:text-blue-300 text-sm mr-2">Edit</button>
         <button onclick="hideBet(${bet.id})" class="text-gray-400 hover:text-gray-300 text-sm mr-2">Hide</button>
         <button onclick="showConfirmationModal(${bet.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>` :
        `<button onclick="hideBet(${bet.id})" class="text-gray-400 hover:text-gray-300 text-sm mr-2">Hide</button>
         <button onclick="showConfirmationModal(${bet.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>`;

      const playerDisplay = bet.batterTeam ? `${bet.batter} (${bet.batterTeam})` : bet.batter;
      
      card.innerHTML = `
        <div class="mb-3">
          <div class="flex justify-between items-center mb-2">
            <div class="font-bold text-xl text-yellow-400">${bet.bettor}</div>
            <div class="font-bold text-xl text-yellow-400">${bet.betDate}</div>
            <div class="flex items-center gap-2">
              ${statusBadge}
            </div>
          </div>
          <div class="flex justify-between items-start">
            <div>
              <div class="text-base text-gray-300"><span class="font-bold text-lg">${playerDisplay}</span></div>
              <div class="text-xs text-gray-500">${bet.sportsbook}</div>
            </div>
            <div class="flex flex-col gap-1">
              ${actionButtons}
            </div>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-base">
          <span class="text-gray-400">Bet: <span class="text-white font-semibold">$${bet.amount}</span></span>
          <span class="text-gray-400 text-center">Odds: <span class="text-white font-semibold">${bet.odds}</span></span>
          <span class="text-gray-400 text-right">To Win: <span class="text-green-400 font-semibold">$${potentialWin.toFixed(2)}</span></span>
        </div>
        ${bet.status === 'won' ? `<div class="mt-2 text-green-400 font-bold">Won: $${bet.winnings.toFixed(2)}</div>` : ''}
      `;
      
      return card;
    }

    function updateBetSummary() {
      const visibleBets = activeBets.filter(bet => !bet.hidden);
      const totalWagered = visibleBets.reduce((sum, bet) => sum + bet.amount, 0);
      const totalWinnings = visibleBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + bet.winnings, 0);
      const netPL = totalWinnings - totalWagered;

      totalWageredEl.textContent = `$${totalWagered.toFixed(2)}`;
      totalWinningsEl.textContent = `$${totalWinnings.toFixed(2)}`;
      netPlEl.textContent = `$${netPL.toFixed(2)}`;
      netPlEl.className = `text-xl font-bold ${netPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    async function checkBetMatches(homeRuns) {
      let betsUpdated = false;
      const selectedDate = dateSelector.value;
      
      // Get game status information for the selected date
      const gameStatuses = await getGameStatuses(selectedDate);
      
      activeBets.forEach(bet => {
        if (bet.status !== 'active') return;
        
        // Only check bets for the selected date
        if (bet.betDate !== selectedDate) return;
        
        const matchingHR = homeRuns.find(hr =>
          hr.batter.name.toLowerCase().includes(bet.batter.toLowerCase()) ||
          bet.batter.toLowerCase().includes(hr.batter.name.toLowerCase())
        );
        
        if (matchingHR) {
          bet.status = 'won';
          bet.winnings = bet.amount + calculateWinnings(bet.amount, bet.odds);
          betsUpdated = true;
        } else {
          // Check if the player's game is over and they didn't hit a home run
          const playerGameStatus = gameStatuses.find(game =>
            game.players.some(player =>
              player.name.toLowerCase().includes(bet.batter.toLowerCase()) ||
              bet.batter.toLowerCase().includes(player.name.toLowerCase())
            )
          );
          
          if (playerGameStatus && playerGameStatus.isGameOver) {
            bet.status = 'lost';
            bet.winnings = 0;
            betsUpdated = true;
          }
        }
      });
      
      if (betsUpdated) {
        localStorage.setItem('hrBets', JSON.stringify(activeBets));
        renderActiveBets();
        updateBetSummary();
      }
    }

    async function getGameStatuses(date) {
      try {
        const scheduleUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${date}`;
        const scheduleResp = await fetch(scheduleUrl);
        const scheduleData = await scheduleResp.json();

        const gameStatuses = [];
        
        for (const dateObj of scheduleData.dates) {
          for (const game of dateObj.games) {
            try {
              // Get game status and player roster
              const [gameResp, boxscoreResp] = await Promise.all([
                fetch(`https://statsapi.mlb.com/api/v1.1/game/${game.gamePk}/feed/live`),
                fetch(`https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`)
              ]);
              
              if (gameResp.ok && boxscoreResp.ok) {
                const gameData = await gameResp.json();
                const boxscoreData = await boxscoreResp.json();
                
                const gameStatus = gameData.gameData?.status?.detailedState || '';
                const isGameOver = gameStatus === 'Final' || gameStatus.includes('Completed') || gameStatus.includes('Game Over');
                
                // Extract players from both teams
                const players = [];
                const teams = [boxscoreData.teams?.away, boxscoreData.teams?.home].filter(Boolean);
                
                teams.forEach(team => {
                  if (team.players) {
                    Object.values(team.players).forEach(player => {
                      if (player.person && player.position &&
                          player.position.type !== 'Pitcher' &&
                          player.position.abbreviation !== 'P') {
                        players.push({
                          id: player.person.id,
                          name: player.person.fullName
                        });
                      }
                    });
                  }
                });
                
                gameStatuses.push({
                  gameId: game.gamePk,
                  isGameOver,
                  status: gameStatus,
                  players
                });
              }
            } catch (e) {
              console.warn(`Error fetching game ${game.gamePk} status:`, e);
            }
          }
        }
        
        return gameStatuses;
      } catch (error) {
        console.error('Error fetching game statuses:', error);
        return [];
      }
    }

    // Make functions available globally
    window.removeBet = removeBet;
    window.showConfirmationModal = showConfirmationModal;
    window.hideBet = hideBet;
    window.unhideBet = unhideBet;
    window.showEditModal = showEditModal;

    function calculatePayouts() {
      const payoutDate = document.getElementById('payout-date').value;
      if (!payoutDate) return;
      
      // Get all bets for the selected date
      const dateBets = activeBets.filter(bet => bet.betDate === payoutDate);
      
      if (dateBets.length === 0) {
        showPayoutResults([], payoutDate);
        return;
      }
      
      // Group bets by bettor
      const bettorData = {};
      
      dateBets.forEach(bet => {
        if (!bettorData[bet.bettor]) {
          bettorData[bet.bettor] = {
            name: bet.bettor,
            totalWagered: 0,
            totalWon: 0,
            bets: []
          };
        }
        
        bettorData[bet.bettor].totalWagered += bet.amount;
        bettorData[bet.bettor].bets.push(bet);
        
        if (bet.status === 'won') {
          bettorData[bet.bettor].totalWon += bet.winnings;
        }
      });
      
      // Calculate totals
      const totalWagered = dateBets.reduce((sum, bet) => sum + bet.amount, 0);
      const totalWon = dateBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + bet.winnings, 0);
      const uniqueBettors = Object.keys(bettorData).length;
      
      // Calculate total pool payout: sum of each winner's (winnings - total wagered for the day) divided by number of bettors
      let totalPoolPayout = 0;
      Object.values(bettorData).forEach(bettor => {
        const hasWinningBets = bettor.bets.some(bet => bet.status === 'won');
        if (hasWinningBets) {
          // For each winner: (total winnings - total wagered for the day) divided by total number of bettors
          const individualProfit = bettor.totalWon - bettor.totalWagered;
          totalPoolPayout += individualProfit / uniqueBettors;
        }
      });
      
      // Calculate each bettor's payout
      const payoutResults = Object.values(bettorData).map(bettor => {
        const hasWinningBets = bettor.bets.some(bet => bet.status === 'won');
        // If bettor has winning bets, they get all their bets back + total pool payout
        // If no winning bets, they only get the total pool payout
        const finalPayout = hasWinningBets ? bettor.totalWagered + totalPoolPayout : totalPoolPayout;
        
        // Calculate individual pool contribution for winners
        let individualPoolContribution = 0;
        if (hasWinningBets) {
          individualPoolContribution = (bettor.totalWon - bettor.totalWagered) / uniqueBettors;
        }
        
        return {
          ...bettor,
          hasWinningBets,
          poolPayout: totalPoolPayout,
          individualPoolContribution,
          finalPayout,
          profit: finalPayout - bettor.totalWagered
        };
      });
      
      showPayoutResults(payoutResults, payoutDate, {
        totalBets: dateBets.length,
        totalWagered,
        totalWon,
        totalProfit: totalWon - totalWagered,
        uniqueBettors,
        poolPayoutPerPerson: totalPoolPayout
      });
    }
    
    function showPayoutResults(results, date, summary = null) {
      const resultsDiv = document.getElementById('payout-results');
      const breakdownDiv = document.getElementById('payout-breakdown');
      
      if (results.length === 0) {
        resultsDiv.classList.remove('hidden');
        // Restore the original summary structure instead of replacing it
        const summaryDiv = document.getElementById('payout-summary');
        summaryDiv.innerHTML = `
          <div class="text-sm text-gray-300">
            <div>Total Bets: <span id="total-bets-count" class="text-white font-semibold">0</span></div>
            <div>Total Wagered: <span id="total-wagered-amount" class="text-white font-semibold">$0.00</span></div>
            <div>Total Won: <span id="total-won-amount" class="text-green-400 font-semibold">$0.00</span></div>
            <div>Total Profit: <span id="total-profit-amount" class="text-green-400 font-semibold">$0.00</span></div>
            <div>Unique Bettors: <span id="unique-bettors-count" class="text-white font-semibold">0</span></div>
            <div>Pool Payout Per Person: <span id="pool-payout-per-person" class="text-yellow-400 font-semibold">$0.00</span></div>
          </div>
          <div class="text-center text-gray-400 mt-3">No bets found for ${date}</div>
        `;
        breakdownDiv.innerHTML = '';
        return;
      }
      
      // Update summary
      document.getElementById('total-bets-count').textContent = summary.totalBets;
      document.getElementById('total-wagered-amount').textContent = `$${summary.totalWagered.toFixed(2)}`;
      document.getElementById('total-won-amount').textContent = `$${summary.totalWon.toFixed(2)}`;
      document.getElementById('total-profit-amount').textContent = `$${summary.totalProfit.toFixed(2)}`;
      document.getElementById('unique-bettors-count').textContent = summary.uniqueBettors;
      document.getElementById('pool-payout-per-person').textContent = `$${summary.poolPayoutPerPerson.toFixed(2)}`;
      
      // Update breakdown
      breakdownDiv.innerHTML = '';
      
      results.forEach(bettor => {
        const card = document.createElement('div');
        card.className = 'bg-slate-700 p-3 rounded-lg';
        
        const wonBets = bettor.bets.filter(bet => bet.status === 'won').length;
        const lostBets = bettor.bets.filter(bet => bet.status === 'lost').length;
        const activeBets = bettor.bets.filter(bet => bet.status === 'active').length;
        
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <div class="flex items-center">
                <div class="font-bold ${bettor.hasWinningBets ? 'text-yellow-400' : 'text-white'} w-24">${bettor.name}</div>
                ${bettor.hasWinningBets ? `<div class="text-xs text-blue-400 mt-1 ml-8">Pool contribution: $${bettor.individualPoolContribution.toFixed(2)}</div>` : ''}
              </div>
              <div class="text-xs text-gray-400">
                ${bettor.bets.length} bets: ${wonBets} won, ${lostBets} lost, ${activeBets} active
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold ${bettor.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${bettor.profit >= 0 ? '+' : ''}$${bettor.profit.toFixed(2)}</div>
              <div class="text-xs text-gray-400">profit</div>
            </div>
          </div>
          <div class="grid grid-cols-4 gap-2 text-xs">
            <div class="text-center">
              <div class="text-gray-400">Total Wagered</div>
              <div class="text-white font-semibold">$${bettor.totalWagered.toFixed(2)}</div>
            </div>
            <div class="text-center">
              <div class="text-gray-400">Bets Back</div>
              <div class="text-green-400 font-semibold">$${bettor.hasWinningBets ? bettor.totalWagered.toFixed(2) : '0.00'}</div>
            </div>
            <div class="text-center">
              <div class="text-gray-400">Pool Payout</div>
              <div class="text-yellow-400 font-semibold">$${bettor.poolPayout.toFixed(2)}</div>
            </div>
            <div class="text-center">
              <div class="text-gray-400">Final Payout</div>
              <div class="text-green-400 font-bold">$${bettor.finalPayout.toFixed(2)}</div>
            </div>
          </div>
        `;
        
        breakdownDiv.appendChild(card);
      });
      
      resultsDiv.classList.remove('hidden');
    }

    async function getDingerData() {
      const selectedDate = dateSelector.value;
      
      loadingState.classList.remove('hidden');
      errorMessage.classList.add('hidden');
      summarySection.classList.add('hidden');
      hrList.classList.add('hidden');

      try {

        const scheduleUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${selectedDate}`;
        const scheduleResp = await fetch(scheduleUrl);
        const scheduleData = await scheduleResp.json();

        // Collect all game URLs for parallel fetching
        const gameUrls = [];
        for (const date of scheduleData.dates) {
          for (const game of date.games) {
            gameUrls.push(`https://statsapi.mlb.com/api/v1.1/game/${game.gamePk}/feed/live`);
          }
        }

        // Fetch all games in parallel
        const gamePromises = gameUrls.map(url => fetch(url).then(r => r.json()));
        const gameDataArray = await Promise.all(gamePromises);

        const allHomers = [];
        
        // Process all games
        for (const gameData of gameDataArray) {
          const plays = gameData.liveData.plays.allPlays;
          const homeTeam = gameData.gameData?.teams?.home || {};
          const awayTeam = gameData.gameData?.teams?.away || {};

          for (const play of plays) {
            if (play.result.event === "Home Run" && play.matchup?.batter && play.matchup?.pitcher) {
              const batter = play.matchup.batter;
              const pitcher = play.matchup.pitcher;
              const runners = play.runners || [];
              let hitData = {};
              const hitEvent = play.playEvents?.find(event => event.hitData);
              if (hitEvent?.hitData) hitData = hitEvent.hitData;

              let pitchData = {};
              const pitchEvents = play.playEvents?.filter(event => event.isPitch && event.pitchData) || [];
              if (pitchEvents.length > 0) {
                const finalPitch = pitchEvents[pitchEvents.length - 1];
                pitchData = finalPitch.pitchData || {};
              }

              const isTopInning = play.about?.isTopInning;
              const batterTeam = isTopInning ? awayTeam : homeTeam;
              const pitcherTeam = isTopInning ? homeTeam : awayTeam;

              const hrObj = {
                batter: {
                  id: batter.id,
                  name: batter.fullName || 'Unknown',
                  handedness: play.matchup.batSide?.code || 'N/A',
                  homeRunCount: null
                },
                pitcher: {
                  id: pitcher.id,
                  name: pitcher.fullName || 'Unknown',
                  handedness: play.matchup.pitchHand?.code || 'N/A',
                  hrPer9: null,
                  pitchType: pitchData.type?.description || play.playEvents?.find(event => event.isPitch)?.details?.type?.description || 'Unknown',
                  pitchSpeed: pitchData.startSpeed || null
                },
                hit: { ev: hitData.launchSpeed || null, la: hitData.launchAngle || null, dist: hitData.totalDistance || null },
                scenario: {
                  inning: play.about?.inning || 'N/A',
                  outs: play.count?.outs || 0,
                  runnersOn: (() => {
                    const bases = [];
                    if (runners && runners.length > 0) {
                      for (const r of runners) {
                        const start = r.movement?.start;
                        if (start === "1B" || start === "2B" || start === "3B") {
                          bases.push(start);
                        }
                      }
                      
                      if (bases.length === 0) {
                        const playDesc = play.result?.description || "";
                        if (playDesc.includes("2-run") || playDesc.includes("two-run")) {
                          bases.push("1B");
                        }
                        if (playDesc.includes("3-run") || playDesc.includes("three-run")) {
                          bases.push("1B", "2B");
                        }
                        if (playDesc.includes("grand slam")) {
                          bases.push("1B", "2B", "3B");
                        }
                      }
                    }
                    return bases;
                  })(),
                  count: (play.count?.balls || 0) + "-" + (play.count?.strikes || 0)
                },
                hrTimestamp: play.about?.startTime || null,
                batterLogo: batterTeam.id ? "https://www.mlbstatic.com/team-logos/" + batterTeam.id + ".svg" : '',
                pitcherLogo: pitcherTeam.id ? "https://www.mlbstatic.com/team-logos/" + pitcherTeam.id + ".svg" : ''
              };
              
              allHomers.push(hrObj);
            }
          }
        }

        allHomers.sort((a,b) => new Date(b.hrTimestamp).getTime() - new Date(a.hrTimestamp).getTime() );

        // Fetch player stats in parallel
        const uniqueBatters = [...new Set(allHomers.map(hr => hr.batter.id))];
        const uniquePitchers = [...new Set(allHomers.map(hr => hr.pitcher.id))];
        
        const batterStatsPromises = uniqueBatters.map(async (batterId) => {
          try {
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/people/${batterId}/stats?stats=season&group=hitting`);
            if (resp.ok) {
              const data = await resp.json();
              const seasonStats = data.stats?.find(stat => stat.type?.displayName === 'season');
              return { id: batterId, homeRuns: seasonStats?.splits?.[0]?.stat?.homeRuns || null };
            }
          } catch(e) {
            console.warn("Error fetching batter stats", e);
          }
          return { id: batterId, homeRuns: null };
        });

        const pitcherStatsPromises = uniquePitchers.map(async (pitcherId) => {
          try {
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/people/${pitcherId}/stats?stats=season&group=pitching`);
            if (resp.ok) {
              const data = await resp.json();
              const seasonStats = data.stats?.find(stat => stat.type?.displayName === 'season');
              return { id: pitcherId, hrPer9: seasonStats?.splits?.[0]?.stat?.homeRunsPer9 || null };
            }
          } catch(e) {
            console.warn("Error fetching pitcher stats", e);
          }
          return { id: pitcherId, hrPer9: null };
        });

        const [batterStats, pitcherStats] = await Promise.all([
          Promise.all(batterStatsPromises),
          Promise.all(pitcherStatsPromises)
        ]);

        // Apply stats to home runs
        const batterStatsMap = new Map(batterStats.map(b => [b.id, b.homeRuns]));
        const pitcherStatsMap = new Map(pitcherStats.map(p => [p.id, p.hrPer9]));

        allHomers.forEach(hr => {
          hr.batter.homeRunCount = batterStatsMap.get(hr.batter.id) || 'N/A';
          hr.pitcher.hrPer9 = pitcherStatsMap.get(hr.pitcher.id) || 'N/A';
        });

        // Store current home runs and check for bet matches
        currentHomeRuns = allHomers;
        checkBetMatches(allHomers);

        renderSummaryStats(allHomers);
        renderHomeRuns(allHomers);
        updateLastUpdated();

        loadingState.classList.add('hidden');
        summarySection.classList.remove('hidden');
        hrList.classList.remove('hidden');
        document.getElementById('last-updated').classList.remove('hidden');
      } catch {
        loadingState.classList.add('hidden');
        errorMessage.classList.remove('hidden');
      }
    }

    function renderHomeRuns(data) {
      hrList.innerHTML = '';
      
      // Group home runs by player and find the first (earliest) home run for each player
      const playerFirstHR = new Map();
      data.forEach(hr => {
        const playerKey = hr.batter.name.toLowerCase();
        const hrTime = new Date(hr.hrTimestamp).getTime();
        
        if (!playerFirstHR.has(playerKey) || hrTime < playerFirstHR.get(playerKey).time) {
          playerFirstHR.set(playerKey, { hr: hr, time: hrTime });
        }
      });
      
      data.forEach(hr => {
        // Check if this home run matches any bets for the selected date
        const selectedDate = dateSelector.value;
        let matchingBets = activeBets.filter(bet =>
          bet.status === 'won' &&
          bet.betDate === selectedDate && (
            hr.batter.name.toLowerCase().includes(bet.batter.toLowerCase()) ||
            bet.batter.toLowerCase().includes(hr.batter.name.toLowerCase())
          )
        );

        // Only show winning bets on the first (earliest) home run for each player
        const playerKey = hr.batter.name.toLowerCase();
        const isFirstHR = playerFirstHR.get(playerKey)?.hr === hr;
        
        if (!isFirstHR) {
          matchingBets = []; // Don't show bets on subsequent home runs
        }

        const card = document.createElement('div');
        card.className = `bg-slate-800 p-4 rounded-lg hover:scale-[1.01] transition ${matchingBets.length > 0 ? 'border-l-4 border-green-400' : ''}`;
        const timeStr = hr.hrTimestamp ? new Date(hr.hrTimestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'N/A';

        // For bases, show tighter diamond (1B,2B,3B) using flexbox
        const bases = '<div class="flex flex-col items-center text-center text-xs">'
                    + '<div><span class="w-2.5 h-2.5 rounded-full ' + (hr.scenario.runnersOn.includes("2B")?'bg-yellow-400':'bg-slate-600') + ' inline-block"></span></div>'
                    + '<div class="flex justify-between w-12">'
                    + '<span class="w-2.5 h-2.5 rounded-full ' + (hr.scenario.runnersOn.includes("3B")?'bg-yellow-400':'bg-slate-600') + ' inline-block"></span>'
                    + '<span class="w-2.5 h-2.5 rounded-full ' + (hr.scenario.runnersOn.includes("1B")?'bg-yellow-400':'bg-slate-600') + ' inline-block"></span>'
                    + '</div>'
                    + '</div>';

        // Outs as 3 small red/gray circles in a row
        const outs = '<div class="flex gap-1">'
                   + [0,1,2].map(i => '<span class="w-2 h-2 rounded-full ' + (hr.scenario.outs>i?'bg-red-500':'bg-slate-600') + ' inline-block"></span>').join('')
                   + '</div>';

        // Separate hitting and pitching stats for responsive layout
        const hittingStats = [];
        const pitchingStats = [];
        
        if (hr.hit.ev && hr.hit.ev !== 'N/A') {
          hittingStats.push('<div class="bg-slate-700 rounded-lg p-1 sm:p-2 lg:p-3"><div class="text-gray-400 text-xs sm:text-sm">EV</div><div class="font-bold text-sm sm:text-base lg:text-lg">'+hr.hit.ev+' mph</div></div>');
        }
        if (hr.hit.la && hr.hit.la !== 'N/A') {
          hittingStats.push('<div class="bg-slate-700 rounded-lg p-1 sm:p-2 lg:p-3"><div class="text-gray-400 text-xs sm:text-sm">LA</div><div class="font-bold text-sm sm:text-base lg:text-lg">'+hr.hit.la+'°</div></div>');
        }
        if (hr.hit.dist && hr.hit.dist !== 'N/A') {
          hittingStats.push('<div class="bg-slate-700 rounded-lg p-1 sm:p-2 lg:p-3"><div class="text-gray-400 text-xs sm:text-sm">Dist</div><div class="font-bold text-sm sm:text-base lg:text-lg">'+hr.hit.dist+' ft</div></div>');
        }
        
        if (hr.pitcher.pitchType && hr.pitcher.pitchType !== 'N/A' && hr.pitcher.pitchType !== 'Unknown') {
          const pitchTextSize = hr.pitcher.pitchType.length > 8 ? 'text-xs' : hr.pitcher.pitchType.length > 6 ? 'text-xs sm:text-sm' : 'text-sm sm:text-base lg:text-lg';
          pitchingStats.push('<div class="bg-slate-700 rounded-lg p-1 sm:p-2 lg:p-3"><div class="text-gray-400 text-xs sm:text-sm">Pitch</div><div class="font-bold '+pitchTextSize+'">'+hr.pitcher.pitchType+'</div></div>');
        }
        if (hr.pitcher.pitchSpeed && hr.pitcher.pitchSpeed !== 'N/A') {
          pitchingStats.push('<div class="bg-slate-700 rounded-lg p-1 sm:p-2 lg:p-3"><div class="text-gray-400 text-xs sm:text-sm">Velo</div><div class="font-bold text-sm sm:text-base lg:text-lg">'+hr.pitcher.pitchSpeed+' mph</div></div>');
        }

        card.innerHTML = ''
          + (matchingBets.length > 0 ? '<div class="mb-3 p-2 bg-green-900 rounded-lg border border-green-400"><div class="text-green-400 font-bold text-sm">🎉 WINNING BETS:</div>' + matchingBets.map(bet => `<div class="text-xs text-green-300">${bet.bettor} won $${bet.winnings.toFixed(2)} (${bet.odds})</div>`).join('') + '</div>' : '')
          + '<div class="flex flex-col md:grid md:grid-cols-3 gap-4 items-center mb-3">'
            + '<div class="flex flex-col items-center gap-2">'
              + '<div class="flex items-center gap-2 justify-center md:justify-start md:ml-4">'
                + (hr.batterLogo ? '<div class="bg-white rounded p-1"><img src="'+hr.batterLogo+'" class="w-8 h-8"></div>' : '')
                + '<div>'
                  + '<div class="font-bold text-yellow-400">'+hr.batter.name+'</div>'
                  + '<div class="text-xs text-gray-400">'+hr.batter.handedness+' | HR: '+(hr.batter.homeRunCount || 'N/A')+'</div>'
                + '</div>'
              + '</div>'
              + (hittingStats.length > 0 ? '<div class="md:hidden grid grid-cols-'+Math.min(hittingStats.length, 3)+' gap-1 text-center mt-2">' + hittingStats.join('') + '</div>' : '')
            + '</div>'
            + '<div class="flex flex-col items-center text-xs text-gray-400 gap-1">'
              + '<div class="flex items-center gap-2 flex-wrap justify-center">'
                + '<span class="text-gray-500">⏱ '+timeStr+'</span>'
                + '<span>'+hr.scenario.inning+(hr.scenario.inning.toString().endsWith('1') && hr.scenario.inning !== '11' ? 'st' : hr.scenario.inning.toString().endsWith('2') && hr.scenario.inning !== '12' ? 'nd' : hr.scenario.inning.toString().endsWith('3') && hr.scenario.inning !== '13' ? 'rd' : 'th')+' inning</span>'
              + '</div>'
              + '<div class="flex items-center gap-2 flex-wrap justify-center">'
                + bases
                + outs
                + '<span>'+hr.scenario.count+'</span>'
              + '</div>'
            + '</div>'
            + '<div class="flex flex-col items-center gap-2">'
              + '<div class="flex items-center gap-2 justify-center md:justify-end md:mr-4">'
                + '<div class="text-center md:text-right">'
                  + '<div class="font-bold text-white">'+hr.pitcher.name+'</div>'
                  + '<div class="text-xs text-gray-400">'+hr.pitcher.handedness+' | HR/9: '+(hr.pitcher.hrPer9 || 'N/A')+'</div>'
                + '</div>'
                + (hr.pitcherLogo ? '<div class="bg-white rounded p-1"><img src="'+hr.pitcherLogo+'" class="w-8 h-8"></div>' : '')
              + '</div>'
              + (pitchingStats.length > 0 ? '<div class="md:hidden grid grid-cols-'+Math.min(pitchingStats.length, 2)+' gap-1 text-center mt-2">' + pitchingStats.join('') + '</div>' : '')
            + '</div>'
          + '</div>'
          + (() => {
            const allStats = [...hittingStats, ...pitchingStats];
            if (allStats.length > 0) {
              const gridCols = allStats.length === 1 ? 'grid-cols-1' :
                              allStats.length === 2 ? 'grid-cols-2' :
                              allStats.length === 3 ? 'grid-cols-3' :
                              allStats.length === 4 ? 'grid-cols-4' : 'grid-cols-5';
              return '<div class="hidden md:grid '+gridCols+' gap-1 sm:gap-2 lg:gap-3 text-center mt-4">' + allStats.join('') + '</div>';
            } else {
              return '';
            }
          })();
        hrList.appendChild(card);
      });
    }

    function renderSummaryStats(all) {
      hrCountEl.textContent = all.length;
      
      // Show/hide avg exit velocity based on data availability
      const withEV = all.filter(h => h.hit.ev && h.hit.ev !== 'N/A');
      const avgExitVelocityContainer = avgExitVelocityEl.parentElement;
      
      if (withEV.length > 0) {
        const avg = (withEV.reduce((s,h)=>s+h.hit.ev,0) / withEV.length).toFixed(1);
        avgExitVelocityEl.textContent = avg;
        avgExitVelocityContainer.style.display = 'block';
      } else {
        avgExitVelocityContainer.style.display = 'none';
      }
      
      // Show/hide time since last based on selected date
      const selectedDate = dateSelector.value;
      const today = new Date();
      const todayStr = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().split('T')[0];
      const timeSinceContainer = document.getElementById('time-since-last').parentElement;
      
      if (selectedDate === todayStr) {
        timeSinceContainer.style.display = 'block';
        
        // Calculate time since last dinger
        const timeSinceEl = document.getElementById('time-since-last');
        if (all.length > 0) {
          const latestHR = all[0]; // Already sorted by timestamp descending
          const latestTime = new Date(latestHR.hrTimestamp);
          const now = new Date();
          const diffMs = now - latestTime;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMins / 60);
          
          if (diffHours > 0) {
            timeSinceEl.textContent = `${diffHours}h ${diffMins % 60}m`;
          } else {
            timeSinceEl.textContent = `${diffMins}m`;
          }
        } else {
          timeSinceEl.textContent = 'N/A';
        }
      } else {
        timeSinceContainer.style.display = 'none';
      }
    }

    function updateLastUpdated() {
      const now = new Date();
      const timeStr = now.toLocaleString();
      document.getElementById('last-updated').textContent = `Last updated: ${timeStr}`;
    }
  </script>
</body>
</html>
